<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RNG Item Pull Game w/ Online Trading</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCV6Potsiz3PqxgxZeCICXsH16BhWNDuh4",
      authDomain: "rng-game-b4bfe.firebaseapp.com",
      projectId: "rng-game-b4bfe",
      storageBucket: "rng-game-b4bfe.firebasestorage.app",
      messagingSenderId: "548702774147",
      appId: "1:548702774147:web:d080b774732dae1772ccb6",
      measurementId: "G-JM523LQ0CS"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);

    // ====== Game Data ======
    const items = [
      { name: "Iron Sword", rarity: "Common" },
      { name: "Leather Boots", rarity: "Common" },
      { name: "Silver Shield", rarity: "Rare" },
      { name: "Mystic Wand", rarity: "Rare" },
      { name: "Dragon Helm", rarity: "Epic" },
      { name: "Phoenix Feather", rarity: "Epic" },
      { name: "Excalibur", rarity: "Legendary" },
      { name: "Orb of Eternity", rarity: "Legendary" }
    ];
    const rarityRates = { "Common": 60, "Rare": 25, "Epic": 10, "Legendary": 5 };

    // ====== State ======
    let username = "";
    let inventory = {}; // local copy

    // ====== Login ======
    window.login = async function login() {
      document.getElementById("login-error").innerText = "";
      const input = document.getElementById("username-input").value.trim();
      if (!input.match(/^[a-zA-Z0-9_]{3,16}$/)) {
        document.getElementById("login-error").innerText = "Username must be 3-16 letters, numbers, or underscores.";
        return;
      }
      username = input;
      const userRef = doc(db, "users", username);
      let userSnap = await getDoc(userRef);
      if (!userSnap.exists()) {
        await setDoc(userRef, { inventory: {} });
        userSnap = await getDoc(userRef);
      }
      inventory = userSnap.data().inventory || {};
      document.getElementById("user-label").innerText = username;
      document.getElementById("login-section").classList.add("hidden");
      document.getElementById("game-section").classList.remove("hidden");
      showInventory();
    };

    // ====== RNG Logic ======
    function itemsByRarity(rarity) { return items.filter(i => i.rarity === rarity); }
    function getRandomRarity() {
      const roll = Math.random() * 100;
      let cumulative = 0;
      for (const [rarity, rate] of Object.entries(rarityRates)) {
        cumulative += rate;
        if (roll < cumulative) return rarity;
      }
      return "Common";
    }
    window.pullItems = async function pullItems(n = 5) {
      const pulled = [];
      for (let i = 0; i < n; i++) {
        const rarity = getRandomRarity();
        const pool = itemsByRarity(rarity);
        const item = pool[Math.floor(Math.random() * pool.length)];
        pulled.push(item);
        addToInventory(item);
      }
      await saveInventory();
      showResult(pulled);
    };
    function addToInventory(item) {
      if (inventory[item.name]) {
        inventory[item.name].count += 1;
      } else {
        inventory[item.name] = { count: 1, rarity: item.rarity };
      }
    }
    async function saveInventory() {
      await updateDoc(doc(db, "users", username), { inventory });
    }

    // ====== Inventory UI ======
    window.showInventory = function showInventory() {
      document.getElementById("result").innerHTML = "";
      document.getElementById("trade-ui").innerHTML = "";
      document.getElementById("trade-incoming").innerHTML = "";
      const invDiv = document.getElementById("inventory");
      invDiv.innerHTML = "<h2>Your Inventory:</h2>";
      if (Object.keys(inventory).length === 0) {
        invDiv.innerHTML += "<p>No items yet!</p>";
        return;
      }
      invDiv.innerHTML += '<div class="inventory-list">';
      for (const [name, data] of Object.entries(inventory)) {
        invDiv.innerHTML += `<div class="inventory-item ${data.rarity}">${name} (${data.rarity}): <b>${data.count}</b></div>`;
      }
      invDiv.innerHTML += '</div>';
    };
    function showResult(pulled) {
      document.getElementById("inventory").innerHTML = "";
      document.getElementById("trade-ui").innerHTML = "";
      document.getElementById("trade-incoming").innerHTML = "";
      document.getElementById("result").innerHTML = "<h2>You pulled:</h2>" +
        pulled.map(item =>
          `<div class="item ${item.rarity}">${item.name} <span style="font-size:14px;">(${item.rarity})</span></div>`
        ).join("");
    }

    // ====== Trading UI ======
    window.showTradeUI = function showTradeUI() {
      document.getElementById("inventory").innerHTML = "";
      document.getElementById("result").innerHTML = "";
      document.getElementById("trade-incoming").innerHTML = "";
      const div = document.getElementById("trade-ui");
      div.innerHTML = `<h2>Send a Trade Offer</h2>
        <p>Recipient's Username: <input type="text" id="trade-username" maxlength="16" /></p>
        <h3>Your Offer:</h3>
        <div id="trade-offer-list"></div>
        <button onclick="addTradeOfferRow()">Add Item to Offer</button>
        <h3>Your Request:</h3>
        <div id="trade-request-list"></div>
        <button onclick="addTradeRequestRow()">Add Item to Request</button>
        <br>
        <button onclick="sendTradeOffer()">Send Trade Offer</button>
        <div id="trade-status"></div>`;
      addTradeOfferRow();
      addTradeRequestRow();
    };

    // ====== Trade Row Adders ======
    window.addTradeOfferRow = function addTradeOfferRow() {
      const div = document.getElementById("trade-offer-list");
      const select = itemDropdown(inventory, "trade-offer-item");
      div.innerHTML += `<div>${select} Qty: <input type="number" min="1" value="1" class="trade-offer-qty" style="width:50px;"/></div>`;
    };
    window.addTradeRequestRow = function addTradeRequestRow() {
      const div = document.getElementById("trade-request-list");
      const select = itemDropdown(items.reduce((acc, i) => { acc[i.name] = i; return acc; }, {}), "trade-request-item");
      div.innerHTML += `<div>${select} Qty: <input type="number" min="1" value="1" class="trade-request-qty" style="width:50px;"/></div>`;
    };
    function itemDropdown(pool, className) {
      return `<select class="${className}">
        ${Object.keys(pool).map(name =>
          `<option value="${name}">${name}</option>`
        ).join("
        )}
        </select>`;
    }

    // ====== Send Trade Offer ======
    window.sendTradeOffer = async function sendTradeOffer() {
      const toUser = document.getElementById("trade-username").value.trim();
      if (!toUser.match(/^[a-zA-Z0-9_]{3,16}$/) || toUser === username) {
        document.getElementById("trade-status").innerText = "Invalid recipient username.";
        return;
      }
      const offerEls = document.getElementsByClassName("trade-offer-item");
      const offerQtys = document.getElementsByClassName("trade-offer-qty");
      const requestEls = document.getElementsByClassName("trade-request-item");
      const requestQtys = document.getElementsByClassName("trade-request-qty");
      const offer = {}, request = {};
      // Build offer
      for (let i = 0; i < offerEls.length; i++) {
        const name = offerEls[i].value;
        const qty = parseInt(offerQtys[i].value);
        if (!name || isNaN(qty) || qty < 1) continue;
        if (!inventory[name] || inventory[name].count < qty) {
          document.getElementById("trade-status").innerText = `Not enough of item: ${name}`;
          return;
        }
        offer[name] = qty;
      }
      // Build request
      for (let i = 0; i < requestEls.length; i++) {
        const name = requestEls[i].value;
        const qty = parseInt(requestQtys[i].value);
        if (!name || isNaN(qty) || qty < 1) continue;
        request[name] = qty;
      }
      if (Object.keys(offer).length === 0 || Object.keys(request).length === 0) {
        document.getElementById("trade-status").innerText = "You must offer and request at least one item.";
        return;
      }
      // Check recipient exists
      const userSnap = await getDoc(doc(db, "users", toUser));
      if (!userSnap.exists()) {
        document.getElementById("trade-status").innerText = "Recipient username does not exist.";
        return;
      }
      // Save trade offer
      await addDoc(collection(db, "trades"), {
        from: username,
        to: toUser,
        offer,
        request,
        status: "pending",
        timestamp: Date.now()
      });
      document.getElementById("trade-status").innerText = "Trade offer sent!";
    };

    // ====== Incoming Trades ======
    window.showIncomingTrades = async function showIncomingTrades() {
      document.getElementById("inventory").innerHTML = "";
      document.getElementById("result").innerHTML = "";
      document.getElementById("trade-ui").innerHTML = "";
      const div = document.getElementById("trade-incoming");
      div.innerHTML = "<h2>Incoming Trade Offers</h2>";
      const tradesRef = collection(db, "trades");
      const q = query(tradesRef, where("to", "==", username), where("status", "==", "pending"));
      const querySnapshot = await getDocs(q);
      if (querySnapshot.empty) {
        div.innerHTML += "<p>No pending trades.</p>";
        return;
      }
      querySnapshot.forEach(docSnap => {
        const trade = docSnap.data();
        div.innerHTML += `<div class="trade-offer">
          <b>From:</b> ${trade.from}<br>
          <b>Offer:</b> ${formatTradeItems(trade.offer)}<br>
          <b>Request:</b> ${formatTradeItems(trade.request)}<br>
          <button onclick="acceptTrade('${docSnap.id}')">Accept</button>
          <button onclick="declineTrade('${docSnap.id}')">Decline</button>
        </div>`;
      });
    };
    function formatTradeItems(obj) {
      return Object.entries(obj).map(([name, qty]) => `${name} x${qty}`).join(", ");
    }

    // ====== Accept/Decline Trades ======
    window.acceptTrade = async function acceptTrade(tradeId) {
      const tradeDoc = await getDoc(doc(db, "trades", tradeId));
      if (!tradeDoc.exists()) return;
      const trade = tradeDoc.data();
      // Check sender's inventory
      const senderRef = doc(db, "users", trade.from);
      const senderSnap = await getDoc(senderRef);
      const senderInv = senderSnap.data().inventory || {};
      for (const [name, qty] of Object.entries(trade.offer)) {
        if (!senderInv[name] || senderInv[name].count < qty) {
          alert(`Sender no longer has enough of item: ${name}. Trade cancelled.`);
          await updateDoc(doc(db, "trades", tradeId), { status: "declined" });
          showIncomingTrades();
          return;
        }
      }
      // Check receiver's inventory (you)
      for (const [name, qty] of Object.entries(trade.request)) {
        if (!inventory[name] || inventory[name].count < qty) {
          alert(`You no longer have enough of item: ${name}. Trade cancelled.`);
          await updateDoc(doc(db, "trades", tradeId), { status: "declined" });
          showIncomingTrades();
          return;
        }
      }
      // Perform trade
      for (const [name, qty] of Object.entries(trade.offer)) {
        senderInv[name].count -= qty;
        if (inventory[name]) inventory[name].count += qty;
        else inventory[name] = { count: qty, rarity: items.find(i => i.name === name).rarity };
      }
      for (const [name, qty] of Object.entries(trade.request)) {
        inventory[name].count -= qty;
        if (senderInv[name]) senderInv[name].count += qty;
        else senderInv[name] = { count: qty, rarity: items.find(i => i.name === name).rarity };
      }
      // Remove zeroes
      Object.keys(senderInv).forEach(k => { if (senderInv[k].count <= 0) delete senderInv[k]; });
      Object.keys(inventory).forEach(k => { if (inventory[k].count <= 0) delete inventory[k]; });
      // Update DB
      await updateDoc(doc(db, "users", trade.from), { inventory: senderInv });
      await updateDoc(doc(db, "users", username), { inventory });
      await updateDoc(doc(db, "trades", tradeId), { status: "accepted" });
      alert("Trade completed!");
      showIncomingTrades();
    };

    window.declineTrade = async function declineTrade(tradeId) {
      await updateDoc(doc(db, "trades", tradeId), { status: "declined" });
      showIncomingTrades();
    };
  </script>
  <style>
    body { font-family: Arial, sans-serif; background: #202c3c; color: #fff; text-align: center; }
    .container { margin-top: 60px; max-width: 700px; margin-left:auto; margin-right:auto; }
    .hidden { display: none; }
    .item { border-radius: 6px; padding: 8px 20px; margin: 8px auto; max-width: 320px; font-weight: bold; font-size: 20px; }
    .Common { background: #cccccc; color: #222; }
    .Rare { background: #4fb4ff; color: #222; }
    .Epic { background: #a266ff; color: #fff; }
    .Legendary { background: gold; color: #222; }
    .inventory-list { margin-top: 10px; text-align: left; display: inline-block; background: #2c3e50; padding: 18px 32px; border-radius: 12px; }
    .inventory-item { margin-bottom: 8px; font-size: 18px; }
    button { padding: 12px 32px; font-size: 18px; background: #3578e5; color: #fff; border: none; border-radius: 8px; cursor: pointer; margin: 12px 0; }
    button:hover { background: #285bb5; }
    input[type="text"], input[type="number"] { padding: 6px; font-size: 18px; border-radius: 5px; border: none; margin: 5px; }
    .trade-offer { background: #263248; padding: 12px; border-radius: 8px; margin: 12px 0; }
    .trade-status { margin-top: 18px; font-size: 18px; }
  </style>
</head>
<body>
<div class="container">
  <h1>RNG Item Pull Game<br>with Online Trading</h1>
  <div id="login-section">
    <p>Enter your username (must be unique):</p>
    <input type="text" id="username-input" maxlength="16" placeholder="Username"/>
    <button onclick="login()">Login</button>
    <div id="login-error" style="color:#e53935;"></div>
  </div>
  
  <div id="game-section" class="hidden">
    <p>Welcome, <b id="user-label"></b>!</p>
    <button onclick="pullItems()">Pull Items!</button>
    <button onclick="showInventory()">Show Inventory</button>
    <button onclick="showTradeUI()">Trade with Another Player</button>
    <button onclick="showIncomingTrades()">View Incoming Trades</button>
    <div class="result" id="result"></div>
    <div class="inventory" id="inventory"></div>
    <div class="trade-ui" id="trade-ui"></div>
    <div class="trade-incoming" id="trade-incoming"></div>
    <div class="trade-status" id="trade-status"></div>
  </div>
</div>
</body>
</html>
